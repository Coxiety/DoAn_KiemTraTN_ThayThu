-- Create database
CREATE DATABASE THI_TRAC_NGHIEM
GO

USE THI_TRAC_NGHIEM
GO

-- Create Users table for authentication
CREATE TABLE Users (
    UserID NCHAR(8) PRIMARY KEY,
    Login NVARCHAR(50) NOT NULL UNIQUE,
    Password NVARCHAR(64) NOT NULL,  -- For SHA-256 hash
    Role NVARCHAR(10) NOT NULL CHECK (Role IN ('TEACHER', 'STUDENT'))
);

-- Create Lop table
CREATE TABLE Lop (
    MALOP NCHAR(8) PRIMARY KEY,
    TENLOP NVARCHAR(40) UNIQUE NOT NULL
);

-- Create Monhoc table
CREATE TABLE Monhoc (
    MAMH NCHAR(5) PRIMARY KEY,
    TENMH NVARCHAR(40) UNIQUE NOT NULL
);

-- Create Giaovien table
CREATE TABLE Giaovien (
    MAGV NCHAR(8) PRIMARY KEY,
    HO NVARCHAR(40),
    TEN NVARCHAR(10),
    SODTLL NCHAR(15),
    DIACHI NVARCHAR(50),
    CONSTRAINT FK_Giaovien_Users FOREIGN KEY (MAGV) REFERENCES Users(UserID)
);

-- Create Sinhvien table
CREATE TABLE Sinhvien (
    MASV NCHAR(8) PRIMARY KEY,
    HO NVARCHAR(40),
    TEN NVARCHAR(10),
    NGAYSINH DATE,
    DIACHI NVARCHAR(100),
    MALOP NCHAR(8) FOREIGN KEY REFERENCES Lop(MALOP),
    CONSTRAINT FK_Sinhvien_Users FOREIGN KEY (MASV) REFERENCES Users(UserID)
);

-- Create Giaovien_Dangky table
CREATE TABLE Giaovien_Dangky (
    MAGV NCHAR(8) FOREIGN KEY REFERENCES Giaovien(MAGV),
    MALOP NCHAR(8) FOREIGN KEY REFERENCES Lop(MALOP),
    MAMH NCHAR(5) FOREIGN KEY REFERENCES Monhoc(MAMH),
    TRINHDO NCHAR(1) CHECK (TRINHDO IN ('A', 'B', 'C')),
    NGAYTHI DATETIME DEFAULT GETDATE(),
    LAN SMALLINT CHECK (LAN >= 1 AND LAN <= 2),
    SOCAUTHI SMALLINT CHECK (SOCAUTHI >= 10 AND SOCAUTHI <= 100),
    THOIGIAN SMALLINT CHECK (THOIGIAN >= 5 AND THOIGIAN <= 60),
    PRIMARY KEY (MALOP, MAMH, LAN)
);

-- Create BODE table
CREATE TABLE BODE (
    MAMH NCHAR(5) FOREIGN KEY REFERENCES Monhoc(MAMH),
    CAUHOI INT IDENTITY(1,1) PRIMARY KEY,
    TRINHDO CHAR(1) CHECK (TRINHDO IN ('A', 'B', 'C')),
    NOIDUNG NVARCHAR(200),
    A NVARCHAR(50),
    B NVARCHAR(50),
    C NVARCHAR(50),
    D NVARCHAR(50),
    DAP_AN NCHAR(1) CHECK (DAP_AN IN ('A', 'B', 'C', 'D')),
    MAGV NCHAR(8) FOREIGN KEY REFERENCES Giaovien(MAGV)
);

-- Create BangDiem table
CREATE TABLE BangDiem (
    MASV NCHAR(8) FOREIGN KEY REFERENCES Sinhvien(MASV),
    MAMH NCHAR(5) FOREIGN KEY REFERENCES Monhoc(MAMH),
    LAN SMALLINT CHECK (LAN >= 1 AND LAN <= 2),
    NGAYTHI DATE DEFAULT GETDATE(),
    DIEM FLOAT CHECK (DIEM >= 0 AND DIEM <= 10),
    PRIMARY KEY (MASV, MAMH, LAN)
);

-- Add indexes for better performance
CREATE INDEX IX_Users_Login ON Users(Login);
CREATE INDEX IX_Sinhvien_Malop ON Sinhvien(MALOP);
CREATE INDEX IX_GiaovienDangky_MagvMalop ON Giaovien_Dangky(MAGV, MALOP);
CREATE INDEX IX_Bode_MamhMagv ON BODE(MAMH, MAGV);
CREATE INDEX IX_Bangdiem_MasvMamh ON BangDiem(MASV, MAMH);

-- Add cascading delete constraints where appropriate
ALTER TABLE Giaovien_Dangky 
ADD CONSTRAINT FK_GVDangky_Giaovien 
FOREIGN KEY (MAGV) REFERENCES Giaovien(MAGV) ON DELETE CASCADE;

ALTER TABLE BODE 
ADD CONSTRAINT FK_BoDe_Giaovien 
FOREIGN KEY (MAGV) REFERENCES Giaovien(MAGV) ON DELETE CASCADE;